(function(l,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(l=typeof globalThis<"u"?globalThis:l||self,E(l["cat-printer"]={}))})(this,function(l){"use strict";var O=Object.defineProperty;var U=(l,E,A)=>E in l?O(l,E,{enumerable:!0,configurable:!0,writable:!0,value:A}):l[E]=A;var b=(l,E,A)=>U(l,typeof E!="symbol"?E+"":E,A);var v=(h=>(h[h.ApplyEnergy=190]="ApplyEnergy",h[h.GetDeviceState=163]="GetDeviceState",h[h.GetDeviceInfo=168]="GetDeviceInfo",h[h.UpdateDevice=169]="UpdateDevice",h[h.SetDpi=164]="SetDpi",h[h.Lattice=166]="Lattice",h[h.Retract=160]="Retract",h[h.Feed=161]="Feed",h[h.Speed=189]="Speed",h[h.Energy=175]="Energy",h[h.Bitmap=162]="Bitmap",h))(v||{}),C=(h=>(h[h.Transfer=0]="Transfer",h[h.Response=1]="Response",h))(C||{});function D(h){let t=0;for(const e of h){t^=e;for(let i=0;i<8;i++)t&128?t=t<<1^7:t<<=1;t&=255}return t}function T(h,t=128){const e=new Uint8Array(Math.ceil(h.length/8));for(let i=0;i<h.length;i++){const r=Math.floor(i/8),o=i%8,n=h[i],a=n&255,s=n>>8&255,c=n>>16&255;(a+s+c)/3<t&&(e[r]|=1<<o)}return e}class R{dither(t,e){const i=t.data,r=e.brightness!==void 0?e.brightness:128;for(let o=0;o<i.length;o+=4){const a=(i[o]+i[o+1]+i[o+2])/3<r?0:255;i[o]=i[o+1]=i[o+2]=a}return t}}class x{constructor(){b(this,"thresholdMap",[[0,2],[3,1]])}dither(t,e){const i=t.data,r=t.width,o=t.height;for(let n=0;n<o;n++)for(let a=0;a<r;a++){const s=(n*r+a)*4,c=i[s],f=i[s+1],g=i[s+2],p=(c+f+g)/3,S=(this.thresholdMap[n%2][a%2]+1)*(255/5),w=p<S?0:255;i[s]=i[s+1]=i[s+2]=w}return t}}class I{dither(t,e){const i=t.data,r=t.width,o=t.height;for(let n=0;n<o;n++)for(let a=0;a<r;a++){const s=(n*r+a)*4,c=i[s],f=i[s+1],g=i[s+2],S=(c+f+g)/3<128?0:255,w=S,u=S,_=S;i[s]=w,i[s+1]=u,i[s+2]=_;const y=c-w,d=f-u,m=g-_;this.distributeError(i,r,a+1,n,y*7/16,d*7/16,m*7/16),this.distributeError(i,r,a-1,n+1,y*3/16,d*3/16,m*3/16),this.distributeError(i,r,a,n+1,y*5/16,d*5/16,m*5/16),this.distributeError(i,r,a+1,n+1,y*1/16,d*1/16,m*1/16)}return t}distributeError(t,e,i,r,o,n,a){if(i>=0&&i<e&&r>=0&&r<t.length/(e*4)){const s=(r*e+i)*4;t[s]=Math.max(0,Math.min(255,t[s]+o)),t[s+1]=Math.max(0,Math.min(255,t[s+1]+n)),t[s+2]=Math.max(0,Math.min(255,t[s+2]+a))}}}class P{dither(t,e){const i=t.data;for(let r=0;r<i.length;r+=4){const o=(i[r]+i[r+1]+i[r+2])/3,n=Math.random()*255,a=o<n?0:255;i[r]=i[r+1]=i[r+2]=a}return t}}class F{constructor(t=3,e=20){b(this,"binSize");b(this,"shadesCount");this.binSize=Math.max(1,Math.floor(t)),this.shadesCount=Math.max(2,Math.floor(e))}dither(t,e){const i=t.data,r=t.width,o=t.height;for(let n=0;n<o;n+=this.binSize)for(let a=0;a<r;a+=this.binSize){let s=0,c=0;const f=Math.min(n+this.binSize,o),g=Math.min(a+this.binSize,r);for(let _=n;_<f;_++)for(let y=a;y<g;y++){const d=(_*r+y)*4,m=i[d],B=i[d+1],G=i[d+2];s+=(m+B+G)/3,c++}const p=s/c,S=255/(this.shadesCount-1),u=Math.min(Math.floor(p/S),this.shadesCount-1)*S;for(let _=n;_<f;_++)for(let y=a;y<g;y++){const d=(_*r+y)*4;i[d]=i[d+1]=i[d+2]=u}}return t}}class N{dither(t,e){const i=t.data,r=t.width,o=t.height,n=4,a=new Uint8ClampedArray(i.length);for(let s=3;s<i.length;s+=4)a[s]=i[s];for(let s=0;s<o;s++)for(let c=0;c<r;c++){const f=(s*r+c)*4,g=(i[f]+i[f+1]+i[f+2])/3,p=Math.floor((255-g)/50),S=Math.floor(c/n)*n,w=Math.floor(s/n)*n,u=c-S,_=s-w,d=Math.sqrt((u-n/2)**2+(_-n/2)**2)<p?0:255;a[f]=a[f+1]=a[f+2]=d}return new ImageData(a,r,o)}}class M{dither(t,e){const i=t.data,r=t.width,o=t.height;for(let n=0;n<o;n++)for(let a=0;a<r;a++){const s=(n*r+a)*4,c=(i[s]+i[s+1]+i[s+2])/3,g=(a%5===0||n%5===0)&&c<128?0:255;i[s]=i[s+1]=i[s+2]=g}return t}}const H=Object.freeze(Object.defineProperty({__proto__:null,BayerDithering:x,BoxDithering:M,DotDithering:N,FloydSteinbergDithering:I,PixelDithering:F,RandomDithering:P,ThresholdDithering:R},Symbol.toStringTag,{value:"Module"}));class V{constructor(t={}){b(this,"device",null);b(this,"server",null);b(this,"txCharacteristic",null);b(this,"rxCharacteristic",null);b(this,"printerState",{outOfPaper:!1,coverOpen:!1,overheat:!1,lowPower:!1,paused:!1,busy:!1});b(this,"options");b(this,"modelName","");this.options={debug:!1,speed:32,energy:24e3,finishFeed:100,...t}}async connect(){if(!navigator.bluetooth)throw new Error("Bluetooth API is not available in this browser");try{if(this.device=await navigator.bluetooth.requestDevice({filters:[{services:[44848]}],optionalServices:[44592]}),this.modelName=this.device.name||"",this.log(`Connected to printer model: ${this.modelName}`),!this.device.gatt)throw new Error("Bluetooth GATT not available");this.server=await this.device.gatt.connect();const t=await this.server.getPrimaryService(44592);return this.txCharacteristic=await t.getCharacteristic(44545),this.rxCharacteristic=await t.getCharacteristic(44546),await this.rxCharacteristic.startNotifications(),this.rxCharacteristic.addEventListener("characteristicvaluechanged",this.handleNotification.bind(this)),await this.getDeviceState(),await this.prepare(this.options.speed,this.options.energy),this.printerState}catch(t){throw console.error("Connection error:",t),t}}async disconnect(){if(this.rxCharacteristic)try{await this.rxCharacteristic.stopNotifications()}catch(t){this.log("Error stopping notifications:",t)}this.server&&this.server.connected&&this.server.disconnect(),this.device=null,this.server=null,this.txCharacteristic=null,this.rxCharacteristic=null,this.log("Disconnected from printer")}getState(){return{...this.printerState}}isConnected(){var t;return((t=this.server)==null?void 0:t.connected)===!0&&this.txCharacteristic!==null}async printText(t,e={}){if(!this.isConnected())throw new Error("Printer not connected");const r={...{fontFamily:"sans-serif",fontSize:16,align:"start",lineSpacing:8,rotate:0,flipH:!1,flipV:!1,brightness:128,offset:0},...e},o=await this.textToBitmap(t,r);r.offset&&r.offset!==0&&(await this.setSpeed(8),r.offset>0?await this.feed(r.offset):await this.retract(-r.offset),await this.setSpeed(this.options.speed)),await this.printBitmap(o)}async printImage(t,e={}){if(!this.isConnected())throw new Error("Printer not connected");const r={...{dither:"bayer",rotate:0,flipH:!1,flipV:!1,brightness:128,offset:0},...e},o=await this.imageToBitmap(t,r);r.offset&&r.offset!==0&&(await this.setSpeed(8),r.offset>0?await this.feed(r.offset):await this.retract(-r.offset),await this.setSpeed(this.options.speed)),await this.printBitmap(o)}async printMultiple(t){if(!this.isConnected())throw new Error("Printer not connected");await this.prepare(this.options.speed,this.options.energy);for(const e of t)e.type==="text"?await this.printText(e.content,e.options):e.type==="image"&&await this.printImage(e.content,e.options);await this.finish(this.options.finishFeed)}async feed(t){if(t<=0)return;const e=this.makeCommand(v.Feed,new Uint8Array([t&255,t>>8&255]));await this.write(e)}async retract(t){if(t<=0)return;const e=this.makeCommand(v.Retract,new Uint8Array([t&255,t>>8&255]));await this.write(e)}async setSpeed(t){const e=this.makeCommand(v.Speed,new Uint8Array([t]));await this.write(e)}async setEnergy(t){const e=new Uint8Array([t&255,t>>8&255,t>>16&255,t>>24&255]),i=this.makeCommand(v.Energy,e);await this.write(i)}async applyEnergy(){const t=this.makeCommand(v.ApplyEnergy,new Uint8Array([1]));await this.write(t)}async getDeviceState(){const t=this.makeCommand(v.GetDeviceState,new Uint8Array([1]));return await this.write(t),this.printerState}async prepare(t,e){await this.setSpeed(t),await this.setEnergy(e),await this.applyEnergy()}async finish(t=0){t>0&&(await this.setSpeed(8),await this.feed(t))}async draw(t){if(!this.isConnected())throw new Error("Printer not connected");const e=this.makeCommand(v.Bitmap,t);await this.write(e)}async printBitmap(t){const{width:e,height:i,data:r}=t,o=Math.ceil(e/8);for(let n=0;n<i;n++){const a=n*o,s=a+o,c=r.slice(a,s);c.every(f=>f===0)||await this.draw(c)}}makeCommand(t,e,i=C.Transfer){return new Uint8Array([81,120,t,i,e.length&255,e.length>>8,...e,D(e),255])}async write(t){if(!this.txCharacteristic)throw new Error("Printer not properly connected");this.log("Sending data:",Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join(" "));try{await this.txCharacteristic.writeValueWithoutResponse(t)}catch(e){throw this.log("Error writing to printer:",e),e}}handleNotification(t){const e=t.target;if(!e.value)return;const i=new Uint8Array(e.value.buffer);if(this.log("Received notification:",Array.from(i).map(r=>r.toString(16).padStart(2,"0")).join(" ")),i.length>=7&&i[2]===v.GetDeviceState){const r=i[6];this.printerState={outOfPaper:!!(r&1),coverOpen:!!(r&2),overheat:!!(r&4),lowPower:!!(r&8),paused:!!(r&16),busy:!!(r&128)},this.log("Printer state updated:",this.printerState)}}async textToBitmap(t,e){const i=document.createElement("canvas"),r=i.getContext("2d");i.width=384,i.height=500,r.fillStyle="white",r.fillRect(0,0,i.width,i.height),r.fillStyle="black";const o=e.fontWeight?`${e.fontWeight} `:"";r.font=`${o}${e.fontSize}px ${e.fontFamily}`,r.textAlign=e.align==="start"?"left":e.align==="end"?"right":e.align;const n=t.split(`
`),a=e.fontSize+(e.lineSpacing||8);let s=e.fontSize;for(const w of n){const u=e.align==="start"?0:e.align==="end"?i.width:i.width/2;r.fillText(w,u,s),s+=a}const c=document.createElement("canvas");c.width=i.width,c.height=s;const f=c.getContext("2d");if(f.drawImage(i,0,0),e.rotate!==0||e.flipH||e.flipV){const w=document.createElement("canvas");w.width=c.width,w.height=c.height;const u=w.getContext("2d");u.save(),u.translate(w.width/2,w.height/2),e.rotate&&e.rotate!==0&&u.rotate(e.rotate*Math.PI/180),e.flipH&&u.scale(-1,1),e.flipV&&u.scale(1,-1),u.drawImage(c,-c.width/2,-c.height/2),u.restore(),c.width=w.width,c.height=w.height,f.drawImage(w,0,0)}const g=f.getImageData(0,0,c.width,c.height),p=new Uint32Array(g.data.buffer),S=T(p);return{width:c.width,height:c.height,data:S}}async imageToBitmap(t,e){const i=new Image;i.crossOrigin="anonymous";const o=await new Promise((d,m)=>{i.onload=()=>d(i),i.onerror=()=>m(new Error(`Failed to load image: ${t}`)),i.src=t}),n=document.createElement("canvas"),a=n.getContext("2d"),s=384,c=o.width/o.height,f=Math.floor(s/c);if(n.width=s,n.height=f,a.fillStyle="white",a.fillRect(0,0,n.width,n.height),a.drawImage(o,0,0,s,f),e.rotate!==0||e.flipH||e.flipV){const d=document.createElement("canvas");d.width=n.width,d.height=n.height;const m=d.getContext("2d");m.save(),m.translate(d.width/2,d.height/2),e.rotate&&e.rotate!==0&&m.rotate(e.rotate*Math.PI/180),e.flipH&&m.scale(-1,1),e.flipV&&m.scale(1,-1),m.drawImage(n,-n.width/2,-n.height/2),m.restore(),n.width=d.width,n.height=d.height,a.drawImage(d,0,0)}const g=a.getImageData(0,0,n.width,n.height);let p=g;if(e.dither&&e.dither!=="none"){if(e.dither==="threshold")p=new R().dither(g,e);else if(e.dither==="bayer")p=new x().dither(g,e);else if(e.dither==="floyd-steinberg")p=new I().dither(g,e);else if(e.dither==="pixel")p=new F().dither(g,e);else if(e.dither==="dot"){const d=new N;p=d.dither(g,e),p=d.dither(g,e)}else e.dither==="box"?p=new M().dither(g,e):e.dither==="random"&&(p=new P().dither(g,e));a.putImageData(p,0,0)}const S=a.getImageData(0,0,n.width,n.height),w=new Uint32Array(S.data.buffer);let u=128;(e.dither==="threshold"||e.dither==="none")&&(u=e.brightness!==void 0?e.brightness:128);const _=T(w,u),y=n.toDataURL("image/png");return{width:n.width,height:n.height,data:_,dataurl:y}}log(...t){this.options.debug&&console.log("[CatPrinter]",...t)}}l.CAT_ADV_SRV=44848,l.CAT_PRINT_RX_CHAR=44546,l.CAT_PRINT_SRV=44592,l.CAT_PRINT_TX_CHAR=44545,l.CatPrinter=V,l.Command=v,l.CommandType=C,l.DEF_CANVAS_WIDTH=384,l.DEF_ENERGY=24e3,l.DEF_FINISH_FEED=100,l.DEF_SPEED=32,l.Dithering=H,l.crc8=D,l.rgbaToBits=T,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
